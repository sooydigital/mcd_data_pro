{% extends 'base.html' %}
{% load static %} {% load permissions_tags %}
{% block title %}
Agregar Votante | MCD
{% endblock %}

{% block headcontent %}
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

{% endblock %}
{% block content %}

<!-- Modal -->
<div class="card">
    <div class="card card-header p-2 principal_color">
        <h2 class="text-center card-title">
            {% if custom_name %}
                {{custom_name}}
            {% else %}
                Ingresar Votante

            {% endif %}
        </h2>
    </div>
    <form method="POST" class="card card-body">
        {% csrf_token %}
        <div class="row g-6 my-4">
            <div class="row md-n3">
                <div class="col col-6 my-2">
                    <label for="inputAddress " class="form-label">Cédula</label>
                    <input required type="number" class="form-control" placeholder="Cédula" id='input_document_id'
                        name="document_id">
                </div>
                <div class="col col-sm-6 my-2">
                    <label for="inputAddress" class="form-label">Validación</label>
                    <br>
                    <div id="status_validation">
                        <div id="loaing_validation" class="spinner-border text-info" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <i id="success_validation" class="fa  fa-2x fa-check-circle verde_color_t invisible"
                            aria-hidden="true"></i>
                        <i id="error_validation" class="fa  fa-2x fa-times-circle red_color_t invisible"
                            aria-hidden="true"></i>
                        <div id="error_message_validation" class="red_color_t invisible">
                            El número de documento que intentas ingresar ya se encuentra registrado en V-Data.
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Nombre</label>
                <input required type="text" class="form-control" placeholder="Nombre" name="first_name">
            </div>
            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Apellido</label>
                <input required type="text" class="form-control" placeholder="Apellido" name="last_name">
            </div>

            
            
            <div class="row">

                <div class="col-sm-6 my-4">
                    <label for="inputAddress" class="form-label">WhatsApp </label>
                    <div class="input-group has-validation">
                        <span class="input-group-text wpp"><i class="fa fa-whatsapp"></i></span>
                        <input required type="number" class="form-control" placeholder="WhatsApp" name="mobile_phone">
                    </div>
                </div>
                
                <div class="col-sm-6">
                    <label for="" class="form-label mx-2">Fecha de nacimiento</label>
                    <div class="input-group">
                        <div class="col-sm-2 mx-2">
                            <label for="day" class="form-label">Dia</label>
                            <select name="day" class="form-control" id="day">
                                {% for day in days %}
                                    <option value="{{day}}">{{day}}</option>
                                {% endfor %}
                            </select>
                        </div>
            
                        <div class="col-sm-2 mx-2">
                            <label for="month" class="form-label">Mes</label>
                            <select name="month" class="form-control" id="month">
                                {% for value,month in months %}
                                    <option value="{{value}}">{{month}}</option>
                                {% endfor %}
                            </select>
                        </div>
            
                        <div class="col-sm-2 mx-2">
                            <label for="year" class="form-label">Año</label>
                            <select name="year" class="form-control" id="year">
                                {% for year in years %}
                                    <option value="{{year}}">{{year}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 my-2">
                <label for="gender" class="form-label">Sexo</label>
                <select required class="form-select" aria-label="Default select example" name="gender" id="gender">
                    <option value="MASCULINO">Masculino</option>
                    <option value="FEMENINO">Femenino</option>
                    <option value="OTRO">Otro</option>
                </select>
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Municipio</label>
                <input type="text" class="form-control" id='select_municipio' name="municipio" placeholder="Municipio">
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Barrio</label>
                <input type="text" class="form-control" id='select_barrio' name="barrio" placeholder="Igresa el nombre de tu barrio">
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Dirección</label>
                <input required type="text" class="form-control" placeholder="Calle 12b #21-21" name="address">
            </div>

            <div class="form-check col-sm-12 my-2">
                <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="flexCheckIndeterminate">
                <label class="form-check-label" for="flexRadioDefault1">
                    En cumplimiento de las disposiciones de la Ley 1581 de 2012 que desarrolla el derecho de habeas data,
                    solicitamos su autorización para recopilar, almacenar, archivar, copiar, analizar, usar y consultar los
                    datos que se señalan a continuación.
                </label>
              </div>

            <div class="d-flex justify-content-center my-5 ">
                <button id="enviar_form" type="submit" class="btn btn-success disabled">Guardar</button>
            </div>

            
        </div>

    </form>
</div>
{% endblock %}

{% block scriptcontent %}
<script type="text/javascript">
    // MODAL
    const myModal = document.getElementById('exampleModal')

    var DOM_IDS = {
        SELECT_MUNICIPIO: 'select_municipio',
        SELECT_BARRIO: 'select_barrio',
        INPUT_DOCUMENT_ID: 'input_document_id',
        BTN_ENVIAR: "enviar_form",
    }

    window.addEventListener('load', function () {
        myModal.classList.add('show-modal')
    });

    $('#' + DOM_IDS.SELECT_MUNICIPIO).on("change", populate_barrios)

    function getBarriosByMunicipio(municipio, successCallback, errorCallback) {
        var url = `/api/get_barrio_by_municipio/${municipio}`
        $.ajax({
            type: 'GET',
            url,
            error: errorCallback,
            success: successCallback
        });
    }

    function checkValidationDocumentId(cc, successCallback, errorCallback) {
        var url = `/api/validate_cc/${cc}`
        $.ajax({
            type: 'GET',
            url,
            error: errorCallback,
            success: successCallback
        });
    }

    function pintarBarrios(barrios) {
        options = []
        element = $('#' + DOM_IDS.SELECT_BARRIO)
        for (var i = 0; i < barrios.length; i++) {
            options.push('<option value="',
                barrios[i].name, '">',
                barrios[i].name, '</option>');
        }
        element.html(options.join(''));

    }
    
    function actualizarValidacion(validation) {
        add_hidden_class("loaing_validation")
        if (validation) {
            add_hidden_class("error_validation")
            add_hidden_class("error_message_validation")
            remove_hidden_class("success_validation")
            $('#' + DOM_IDS.BTN_ENVIAR)[0].classList.remove('disabled')

        } else {
            add_hidden_class("success_validation")
            remove_hidden_class("error_validation")
            remove_hidden_class("error_message_validation")
            $('#' + DOM_IDS.BTN_ENVIAR)[0].classList.add('disabled')
        }
    }

    function barriosSuccessCallback(data) {
        pintarBarrios(data.data)
    }

    function barriosErrorCallback() {
        console.log('barriosErrorCallback, error trayendo la info de los barrios ')

    }

    function validationDocumentIdSuccessCallback(data) {
        actualizarValidacion(data.data)
    }

    function validationDocumentIdErrorCallback() {
        console.log('validationDocumentIdErrorCallback, error validando la info del document ')

    }

    function populate_barrios() {
        municipio = $('#' + DOM_IDS.SELECT_MUNICIPIO).val()
        getBarriosByMunicipio(municipio, barriosSuccessCallback, barriosErrorCallback)
    }

    function add_hidden_class(id) {
        element = $("#" + id)[0]
        element.classList.add("invisible");
    }

    function remove_hidden_class(id) {
        element = $("#" + id)[0]
        element.classList.remove("invisible");
    }



    $("#" + DOM_IDS.INPUT_DOCUMENT_ID).on('change', function (e) {
        document_id = $('#' + DOM_IDS.INPUT_DOCUMENT_ID).val()
        remove_hidden_class("loaing_validation")
        add_hidden_class("success_validation")
        add_hidden_class("error_validation")
        add_hidden_class("error_message_validation")
        
        checkValidationDocumentId(document_id, validationDocumentIdSuccessCallback, validationDocumentIdErrorCallback)
    });

    

    populate_barrios()




</script>
{% endblock %}