{% extends 'base.html' %}
{% load static %} {% load permissions_tags %}
{% block title %}
Agregar Votante | MCD
{% endblock %}

{% block headcontent %}
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

{% endblock %}
{% block content %}

<!-- Modal -->
<div class="show-modal" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title text-center" id="exampleModalLabel">AUTORIZACIÓN PARA EL TRATAMIENTO DE DATOS
                    PERSONALES </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body ">
                En cumplimiento de las disposiciones de la Ley 1581 de 2012 que desarrolla el derecho de habeas data,
                solicitamos su autorización para recopilar, almacenar, archivar, copiar, analizar, usar y consultar los
                datos que se señalan a continuación.
            </div>
            <div class="modal-footer">
                <button id="deny" type="button" class="btn btn-danger " data-bs-dismiss="modal">Negar</button>
                <button id="accepte" type="button" class="btn btn-primary">Aceptar</button>
            </div>
        </div>
    </div>
</div>
<div class="card">
    <div class="card card-header p-2 principal_color">
        <h2 class="text-center card-title">Ingresar Votante</h2>
    </div>
    <form method="POST" class="card card-body">
        {% csrf_token %}
        <div class="row g-6 my-4">
            <div class="row md-n3">
                <div class="col col-6 my-2">
                    <label for="inputAddress " class="form-label">Cédula</label>
                    <input required type="number" class="form-control" placeholder="Cédula" id='input_document_id'
                        name="document_id">
                </div>
                <div class="col col-sm-6 my-2">
                    <label for="inputAddress" class="form-label">Validación</label>
                    <br>
                    <div id="status_validation">
                        <div id="loaing_validation" class="spinner-border text-info" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <i id="success_validation" class="fa  fa-2x fa-check-circle verde_color_t invisible"
                            aria-hidden="true"></i>
                        <i id="error_validation" class="fa  fa-2x fa-times-circle red_color_t invisible"
                            aria-hidden="true"></i>
                        <div id="error_message_validation" class="red_color_t invisible">
                            El número de documento que intentas ingresar ya se encuentra registrado en V-Data.
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Nombre</label>
                <input required type="text" class="form-control" placeholder="Nombre" name="first_name">
            </div>
            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Apellido</label>
                <input required type="text" class="form-control" placeholder="Apellido" name="last_name">
            </div>

            <div class="col-12 my-2">
                <label for="Email" class="form-label">Correo electrónico</label>
                <div class="input-group has-validation">
                    <span class="input-group-text mail">@</span>
                    <input type="email" class="form-control" placeholder="Correo Electrónico" name="email">
                </div>
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">WhatsApp </label>
                <div class="input-group has-validation">
                    <span class="input-group-text wpp"><i class="fa fa-whatsapp"></i></span>
                    <input required type="number" class="form-control" placeholder="WhatsApp" name="mobile_phone">
                </div>
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Fecha de nacimiento</label>
                <input type="date" class="form-control" placeholder="DD/MM/AAAA" name="birthday" value="{{date}}">
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Género</label>
                <select required class="form-select" aria-label="Default select example" name="gender">
                    <option value="HOMBRE">Hombre</option>
                    <option value="MUJER">Mujer</option>
                </select>
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Municipio</label>
                <input type="text" class="form-control" id='select_municipio' name="municipio" placeholder="Municipio">
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Barrio</label>
                <input type="text" class="form-control" id='select_barrio' name="barrio" placeholder="Barrio">
            </div>

            <div class="col-sm-6 my-2">
                <label for="inputAddress" class="form-label">Dirección</label>
                <input required type="text" class="form-control" placeholder="Dirección" name="address">
            </div>

            <div class="d-flex justify-content-center my-5 ">
                <button id="enviar_form" type="submit" class="btn btn-success disabled">Guardar</button>
            </div>
        </div>

    </form>
</div>
{% endblock %}

{% block scriptcontent %}
<script type="text/javascript">
    // MODAL
    const myModal = document.getElementById('exampleModal')
    const denybtn = document.getElementById('deny')
    const acceptebtn = document.getElementById('accepte')

    let disclouser = false

    var DOM_IDS = {
        SELECT_MUNICIPIO: 'select_municipio',
        SELECT_BARRIO: 'select_barrio',
        INPUT_DOCUMENT_ID: 'input_document_id',
        BTN_ENVIAR: "enviar_form",
    }

    window.addEventListener('load', function () {
        myModal.classList.add('show-modal')
    });

    denybtn.addEventListener('click', () => {
        disclouser = false
        myModal.classList.remove('show-modal')
        myModal.style.visibility = "hidden"
        myModal.classList.add('hide-modal')
        return disclouser
    })

    accepte.addEventListener('click', () => {
        disclouser = true
        myModal.classList.remove('show-modal')
        myModal.style.visibility = "hidden"
        myModal.classList.add('hide-modal')

        return disclouser
    })

    $('#' + DOM_IDS.SELECT_MUNICIPIO).on("change", populate_barrios)

    function getBarriosByMunicipio(municipio, successCallback, errorCallback) {
        var url = `/api/get_barrio_by_municipio/${municipio}`
        $.ajax({
            type: 'GET',
            url,
            error: errorCallback,
            success: successCallback
        });
    }

    function checkValidationDocumentId(cc, successCallback, errorCallback) {
        var url = `/api/validate_cc/${cc}`
        $.ajax({
            type: 'GET',
            url,
            error: errorCallback,
            success: successCallback
        });
    }

    function pintarBarrios(barrios) {
        options = []
        element = $('#' + DOM_IDS.SELECT_BARRIO)
        for (var i = 0; i < barrios.length; i++) {
            options.push('<option value="',
                barrios[i].name, '">',
                barrios[i].name, '</option>');
        }
        element.html(options.join(''));

    }

    function actualizarValidacion(validation) {
        add_hidden_class("loaing_validation")
        if (validation) {
            add_hidden_class("error_validation")
            add_hidden_class("error_message_validation")
            remove_hidden_class("success_validation")
            $('#' + DOM_IDS.BTN_ENVIAR)[0].classList.remove('disabled')

        } else {
            add_hidden_class("success_validation")
            remove_hidden_class("error_validation")
            remove_hidden_class("error_message_validation")
            $('#' + DOM_IDS.BTN_ENVIAR)[0].classList.add('disabled')
        }
    }

    function barriosSuccessCallback(data) {
        pintarBarrios(data.data)
    }

    function barriosErrorCallback() {
        console.log('barriosErrorCallback, error trayendo la info de los barrios ')

    }

    function validationDocumentIdSuccessCallback(data) {
        actualizarValidacion(data.data)
    }

    function validationDocumentIdErrorCallback() {
        console.log('validationDocumentIdErrorCallback, error validando la info del document ')

    }

    function populate_barrios() {
        municipio = $('#' + DOM_IDS.SELECT_MUNICIPIO).val()
        getBarriosByMunicipio(municipio, barriosSuccessCallback, barriosErrorCallback)
    }

    function add_hidden_class(id) {
        element = $("#" + id)[0]
        element.classList.add("invisible");
    }

    function remove_hidden_class(id) {
        element = $("#" + id)[0]
        element.classList.remove("invisible");
    }



    $("#" + DOM_IDS.INPUT_DOCUMENT_ID).on('change', function (e) {
        document_id = $('#' + DOM_IDS.INPUT_DOCUMENT_ID).val()
        remove_hidden_class("loaing_validation")
        add_hidden_class("success_validation")
        add_hidden_class("error_validation")
        add_hidden_class("error_message_validation")

        if(disclouser){
            checkValidationDocumentId(document_id, validationDocumentIdSuccessCallback, validationDocumentIdErrorCallback)
        }
    });

    populate_barrios()




</script>
{% endblock %}