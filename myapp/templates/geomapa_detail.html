{% extends 'base.html' %}
{% load static %} {% load permissions_tags %}
{% block headcontent %}
    <script src='https://cdn.plot.ly/plotly-2.17.1.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
{% endblock %}
{% block title %}
    Geo Mapa | MCD
{% endblock %}
{% block content %}

    <h2 class="text-center">
        <i class="fa fa-university" aria-hidden="true"></i>
        {{ name }}
    </h2>

    <div class="container">
        <div class="row mt-4">
            <div class="col text-center d-flex justify-content-center align-items-center">
                Departamento
            </div>
            <div class="col text-center d-flex justify-content-center align-items-center">
                Municipio
            </div>
            <div class="col text-center d-flex justify-content-center align-items-center">
                Votantes agregados
            </div>
        </div>
            <div class="row">

            <div class="col text-center d-flex justify-content-center align-items-center">
                <i class="fa fa-2x fa-bookmark" aria-hidden="true"></i>
                &nbsp
                {{ departamento }}
            </div>
            <div class="col text-center d-flex justify-content-center align-items-center">
                <i class="fa fa-2x fa-university" aria-hidden="true"></i>
                &nbsp
                {{ municipio }}
            </div>
            <div class="col text-center d-flex justify-content-center align-items-center">
                <i class="fa fa-2x fa-thumbs-up" aria-hidden="true"></i>
                &nbsp
                {{ num_puestos }}
            </div>
        </div>
        <div class="row  mt-2">
            <div id='myDiv_super_visor_map'><!-- Plotly chart will be drawn inside this DIV --></div>
        </div>
        <div class="row">
            <p class=" text-end text-muted">{{ name }} - {{ departamento }} - {{ municipio }} - {{ address }}</p>
        </div>

        <div>
            {% if intencion_voto_percentage < 30 %}
                <div class="form-check semaforo_intencion_votos">
                    <input type="radio" class="semaforo rojo"  checked>
                    <input type="radio" class="semaforo naraja" disabled>
                    <input type="radio" class="semaforo verde" disabled>
            </div>
            {% elif intencion_voto_percentage < 80 %}
            <div class="form-check semaforo_intencion_votos">
                <input type="radio" class="semaforo rojo"  checked>
                <input type="radio" class="semaforo naraja"  checked>
                <input type="radio" class="semaforo verde" disabled>
            </div>
            {% else %}
            <div class="form-check semaforo_intencion_votos">
                <input type="radio" class="semaforo rojo"  checked>
                <input type="radio" class="semaforo naraja"  checked>
                <input type="radio" class="semaforo verde"  checked>
            </div>
            {% endif %}

        </div>
        <div class="row mt-5">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col" class="w-50">Nombre</th>
                    <th scope="col" class="text-center">Cédula</th>
                    <th scope="col" class="text-center">Contacto</th>
                    <th scope="col" class="text-center">Mesa</th>
                    <th scope="col" class="text-center">Estructura</th>
                </tr>
                </thead>
                <tbody>
                {% for votante in votantes %}
                    <tr>
                        <th scope="row ">
                            <spam class="table-icon-text">

                                {{ forloop.counter }}
                            </spam>

                        </th>

                        <td>
                            <spam class="table-icon-text ">
                                <a href="{% url 'app:geomapa_detail_by_votante' votante.document_id %}">
                                    {% if votante.is_leader %}
                                        <i class="fa fa-users" aria-hidden="true"></i></a>
                                    {% else %}
                                        <i class="fa fa-user" aria-hidden="true"></i></a>
                                    {% endif %}
                                 &nbsp;{{ votante.name|upper  }}
                            </spam>

                        </td>
                        <td class="text-center">
                            <spam class="table-icon-text">

                                {{ votante.document_id }}
                            </spam>
                        </td>
                        <td>
                            <spam class="table-icon-text">

                                {% if votante.mobile_phone %}
                                 <a class="text-decoration-none" href="tel:{{ votante.mobile_phone }}">
                                        <i class="fa fa-phone table-icon-text" aria-hidden="true"></i>
                                    </a>
                                    <spam class="table-icon-text">
                                        |
                                    </spam>
                                       <a class="text-decoration-none verde_color_t"
                                    href="https://api.whatsapp.com/send?phone=57{{ votante.mobile_phone }}&text=Hola%2C%20Mensaje%20de%20Prueba...%20">
                                        <i class="fa fa-whatsapp table-icon-text" aria-hidden="true"></i>
                                    </a>

                                    {{ votante.show_mobile_phone }}
                                {% endif %}
                            </spam>
                        </td>
                        <td class="text-center">
                            <spam class="table-icon-text">
                            {{ votante.mesa }}</td>
                        </spam>

                        <td class="text-center">
                            <spam class="table-icon-text">
                            {% if votante.is_leader %}
                                <a href="{% url 'app:geomapa_detail_by_leader' votante.id %}"><i class="fa fa-sitemap" aria-hidden="true"></i></a>
                                    &nbsp;|
                                <a href="{% url 'app:insert_votante_sub_link' votante.custom_link %}">
                                    <i class="fa fa-user-plus" aria-hidden="true"></i>
                                </a>
                            {% elif votante.lider_id %}
                                <a href="{% url 'app:geomapa_detail_by_leader' votante.lider_id %}">
                                <i class="fa  fa-sitemap" aria-hidden="true"></i>
                                </a>
                            {% endif %}
                        </td>
                        </spam>

                    </tr>
                {% endfor %}
                </tbody>

            </table>


        </div>
    </div>

{% endblock %}

{% block scriptcontent %}

    <script type="text/javascript">

        function pintarMapa(new_data) {

            lat = new_data.lat
            lon = new_data.lon
            pv_text = new_data.pv_text
            pv_size = new_data.pv_size

            center = {"lat": 5.5384615, "lon": -73.365181}
            {% if request.session.longitude_principal %}
                center = {
                    "lat": {{ request.session.latitude_principal }},
                    "lon": {{ request.session.longitude_principal }}
                }
            {% endif %}

            var data = [
                {
                    "uid": "507651",
                    "mode": "markers",
                    "name": "Puesto de Votación",
                    "type": "scattermapbox",
                    "lat": lat,
                    "lon": lon,
                    "marker": {
                        "meta": {"columnNames": {"size": "Puesto de Votación, size"}},
                        "sizeref": null,
                        "size": pv_size
                    },
                    "text": pv_text,
                    "hoverinfo": "text+name"
                }
            ]

            var layout = {
                "title": {"text": ""},
                "height": 550,
                "legend": {"x": 0, "y": 1},
                "mapbox": {
                    "zoom": 14.25,
                    "pitch": 2,
                    "center": center,
                    "bearing": 0
                },
                "margin": {"b": 40, "l": 40, "r": 40, "t": 40},
                "autosize": true,
                "hovermode": "closest",
                "showlegend": true
            }
            var config = {
                "mapboxAccessToken": "pk.eyJ1IjoiY2hyaWRkeXAiLCJhIjoiY2lxMnVvdm5iMDA4dnhsbTQ5aHJzcGs0MyJ9.X9o_rzNLNesDxdra4neC_A"
            }

            Plotly.newPlot("myDiv_super_visor_map", data, layout, config = config);
        }

        data = {
            'lat': ["{{ latitude }}"],
            'lon': ["{{ longitude }}"],
            "pv_text": ["{{ name }}"],
            "pv_size": ["15"],
        }
        pintarMapa(data)

    </script>
{% endblock %}